# === Définition du workflow CI/CD ===
name: CI (Intégration Continue)

# === Déclencheurs ===
# Ce workflow se lance à chaque push sur la branche 'main' ou lors d'une Pull Request
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# === Tâches à exécuter ===
jobs:
  build-and-test:
    # Environnement d'exécution (machine virtuelle Ubuntu fournie par GitHub)
    runs-on: ubuntu-latest
    
    steps:
    # 1. Récupération du code source
    - uses: actions/checkout@v4

    # === BACKEND ===
    
    # 2. Configuration de l'environnement Node.js pour le Backend
    - name: Setup Node.js for Backend
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm' # Utilise le cache NPM pour accélérer les installations
        cache-dependency-path: back/package-lock.json

    # 3. Installation des dépendances Backend
    - name: Install Backend Dependencies
      run: cd back && npm ci

    # 4. Génération du client Prisma (nécessaire avant le build)
    - name: Generate Prisma Client
      run: cd back && npx prisma generate

    - name: Lint Backend
      run: cd back && npm run lint

    - name: Test Backend (Unit)
      run: cd back && npm run test

    # 5. Compilation du Backend (vérifie s'il y a des erreurs TypeScript)
    - name: Build Backend
      run: cd back && npm run build

    # === FRONTEND ===

    # 6. Configuration de l'environnement Node.js pour le Frontend
    - name: Setup Node.js for Frontend
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: front/package-lock.json

    # 7. Installation des dépendances Frontend
    - name: Install Frontend Dependencies
      run: cd front && npm ci

    - name: Lint Frontend
      run: cd front && npm run lint

    # 8. Compilation du Frontend (React/Vite)
    # Vérifie que le code React est valide et peut être compilé pour la production
    - name: Build Frontend
      run: cd front && npm run build
